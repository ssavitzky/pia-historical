XCOMM $Id$

#define IHaveSubdirs
#define PassCDebugFlags

#include "pia.tmpl"

/*** Version and directory stuff for making a CD-ROM ***/
#ifndef vendor_tag
#define vendor_tag PIA
#endif

#ifndef cd_rom_src_dir
#define cd_rom_src_dir /pia1/pia_cd
#endif
#ifndef cd_rom_dest_dir
#define cd_rom_dest_dir /d
#endif
#ifndef cd_rom_pub
#define cd_rom_pub Ricoh California Research Center
#endif

CD_ROM_SRC_DIR	= cd_rom_src_dir
CD_ROM_DEST_DIR	= cd_rom_dest_dir
CD_ROM_PUB      = cd_rom_pub

VENDOR_TAG  = vendor_tag
RELEASE         = 1
MAJOR           = 1
MINOR           = 1
SUFFIX          = 
VERSION_ID = $(VENDOR_TAG)$(RELEASE)_$(MAJOR)_$(MINOR)$(SUFFIX)
VERSION    = $(VENDOR_TAG)$(RELEASE).$(MAJOR).$(MINOR)$(SUFFIX)


/*** Subdirectories ***/

SUBDIRS 	=  bin lib /* Doc src */

/*** Symbolic Links ***/

all::	lib bin
	@echo "symlinks made"

setup::	
	cd lib; make
	cd bin; make

/*** Standard Imake stuff ***/

MakeSubdirs($(SUBDIRS))
DependSubdirs($(SUBDIRS))

/*** Additional subdirs for make Makefiles ***/

DocMakefiles::
	$(MAKE) Makefiles SUBDIRS=Doc

/* Common cvs operations */

cvs_tag::
	cvs tag $(VERSION_ID)

cvs_rtag::
	cvs rtag $(VERSION_ID) rest

/* Stuff for making a CD-ROM */

version_id::
	echo $(VERSION) `date` > version_id

cd_rom:		$(CD_ROM_SRC_DIR) $(CD_ROM_DEST_DIR) version_id
	mkisofs -f -R -T \
	    -P "$(CD_ROM_PUB)" -A $(VERSION_ID) -V $(VERSION_ID) \
	    -o $(CD_ROM_DEST_DIR)/pia.iso $(CD_ROM_SRC_DIR)


/*
 * Checking the release
 */
check::
	check_files $(SUBDIRS) | tee check_files.log

/*
 * Put all CVS files into a tar file for safekeeping.
 */
SRCDIR=src/java/crc
CLASSDIR=src/java

cvs.tar::
	find $(SUBDIRS) -name CVS -print | tar -cT - -f cvs.tar

/*
 * Prepare release
 */
rm_bin_tar:: 
	 rm -f pia_bin.tar.gz
	 rm -f crc.zip
rm_pia_tar::
	rm -f pia.tar.gz
	rm -f crc.zip

prep_rel::

	cd $(SRCDIR); make clean ; make
	cd $(CLASSDIR);make crc.zip; make alldoc

/*
 * Binary release
 */

pia_bin.toc:: rm_bin_tar prep_rel
	cd ..; find pia \! -type d -print \
	    | grep -v CVS | grep -v InternalDoc \
	    | grep -v src > pia/pia_bin.toc 

pia_bin.tar:	pia_bin.toc
	cd ..; /usr/local/bin/tar cfT pia/pia_bin.tar pia/pia_bin.toc ;  /bin/gzip pia/pia_bin.tar

/*
 * Source release
 */

pia.toc:: rm_pia_tar prep_rel
	cd ..;	find pia \! -type d -print \
	    | grep -v CVS | grep -v InternalDoc > pia/pia.toc 

pia.tar:	pia.toc
	cd ..; /usr/local/bin/tar cfT pia/pia.tar pia/pia.toc ;	/bin/gzip pia/pia.tar








